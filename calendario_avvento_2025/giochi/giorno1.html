<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéÑ Giorno 1 ‚Äì Puzzle Natalizio</title>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Ubuntu', sans-serif;
      background-color: #7b0412;
      color: white;
      text-align: center;
      padding: 20px;
      margin: 0;
    }

    h1 { color: #ffd700; margin-bottom: 5px; }
    h2 { font-size: 1.1em; font-weight: normal; margin-top: 0; color: #fff8d9; }

    .timer { font-size: 1.3em; margin: 15px 0; color: #00ff99; }

    .puzzle-container {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-template-rows: repeat(3, 100px);
      gap: 4px;
      justify-content: center;
      margin: 30px auto;
      background-color: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 5px;
    }

    .piece {
      width: 100px;
      height: 100px;
      background-image: url("../img/puzzle_natale.jpg");
      background-size: 300px 300px;
      border-radius: 6px;
      cursor: grab;
      transition: transform 0.2s, box-shadow 0.3s;
    }

    .piece.dragging { opacity: 0.7; transform: scale(1.05); box-shadow: 0 0 10px rgba(255,255,255,0.6); }
    .piece.locked { cursor: default; box-shadow: 0 0 15px #00ff99; opacity: 0.95; }

    .btn {
      display: inline-block;
      margin-top: 20px;
      background-color: #f3e4e4;
      color: #000;
      text-decoration: none;
      padding: 12px 30px;
      border-radius: 30px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .btn:hover { background-color: #b71c1c; color: white; transform: scale(1.05); }

    /* === CLASSIFICA === */
    .leaderboard {
      margin-top: 40px;
      background-color: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 10px;
      width: fit-content;
      margin-inline: auto;
      transition: all 0.4s ease;
      transform: scale(0.9);
      opacity: 0;
    }

    .leaderboard.visible {
      opacity: 1;
      transform: scale(1);
    }

    .leaderboard table {
      border-collapse: collapse;
      width: 100%;
      color: white;
    }

    .leaderboard th, .leaderboard td {
      border-bottom: 1px solid #f5d97c;
      padding: 6px 12px;
    }

    /* === POPUP === */
    .popup {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      visibility: hidden;
      opacity: 0;
      transition: all 0.4s ease;
    }

    .popup.active {
      visibility: visible;
      opacity: 1;
    }

    .popup-content {
      background: #fffaf2;
      color: #400000;
      border-radius: 15px;
      padding: 25px 40px;
      text-align: center;
      box-shadow: 0 0 30px rgba(255,255,255,0.3);
      animation: bounceIn 0.8s ease;
    }

    @keyframes bounceIn {
      0% { transform: scale(0.5); opacity: 0; }
      70% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); }
    }

    .popup button {
      margin-top: 15px;
      background-color: #b71c1c;
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    .popup button:hover {
      background-color: #ffd700;
      color: #000;
    }

    @media (max-width: 600px) {
      .puzzle-container { grid-template-columns: repeat(3, 80px); grid-template-rows: repeat(3, 80px); }
      .piece { width: 80px; height: 80px; background-size: 240px 240px; }
      .popup-content { width: 80%; padding: 20px; }
    }
  </style>
</head>
<body>

  <h1>üéÅ Giorno 1 ‚Äì Ricomponi il Puzzle!</h1>
  <h2 id="utente-nome"></h2>
  <div class="timer" id="timer">‚è± Tempo: 0s</div>

  <div class="puzzle-container" id="puzzle"></div>

  <div class="leaderboard" id="leaderboard">
    <h3>üèÜ Classifica locale</h3>
    <table id="score-table">
      <tr><th>Nome</th><th>Tempo (s)</th></tr>
    </table>
  </div>

  <a href="../calendario.html" class="btn">‚¨Ö Torna al Calendario</a>

  <!-- üéâ POPUP FINALE -->
  <div class="popup" id="popup">
    <div class="popup-content">
      <h2>üéâ Complimenti!</h2>
      <p id="popup-text"></p>
      <button id="close-popup">Vedi Classifica üèÜ</button>
    </div>
  </div>

  <script>
    // === RECUPERA IL NOME SALVATO ===
    const utente = localStorage.getItem("utente") || "Ospite";
    document.getElementById("utente-nome").textContent = `üéÖ Buona fortuna, ${utente}!`;

    const container = document.getElementById('puzzle');
    const timerDisplay = document.getElementById('timer');
    const popup = document.getElementById('popup');
    const popupText = document.getElementById('popup-text');
    const leaderboard = document.getElementById('leaderboard');
    const table = document.getElementById('score-table');
    const closePopup = document.getElementById('close-popup');

    let startTime = Date.now();
    let completato = false;
    const size = 3;
    const pezzi = [];

    // TIMER
    setInterval(() => {
      if (!completato) {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        timerDisplay.textContent = `‚è± Tempo: ${elapsed}s`;
      }
    }, 1000);

    // CREA PEZZI
    for (let i = 0; i < 9; i++) {
      const piece = document.createElement('div');
      piece.classList.add('piece');
      const x = (i % size) * 100;
      const y = Math.floor(i / size) * 100;
      piece.style.backgroundPosition = `-${x}px -${y}px`;
      piece.dataset.row = Math.floor(i / size);
      piece.dataset.col = i % size;
      pezzi.push(piece);
    }

    pezzi.sort(() => Math.random() - 0.5);
    pezzi.forEach((p, i) => {
      p.style.gridRowStart = Math.floor(i / size) + 1;
      p.style.gridColumnStart = (i % size) + 1;
      p.draggable = true;
      container.appendChild(p);
    });

    let dragged = null;

    pezzi.forEach(p => {
      p.addEventListener("dragstart", e => {
        if (p.classList.contains("locked")) { e.preventDefault(); return; }
        dragged = p; p.classList.add("dragging");
      });
      p.addEventListener("dragend", () => p.classList.remove("dragging"));
      p.addEventListener("dragover", e => { if (!p.classList.contains("locked")) e.preventDefault(); });
      p.addEventListener("drop", () => {
        if (p.classList.contains("locked") || dragged.classList.contains("locked")) return;
        const tempRow = p.style.gridRowStart;
        const tempCol = p.style.gridColumnStart;
        p.style.gridRowStart = dragged.style.gridRowStart;
        p.style.gridColumnStart = dragged.style.gridColumnStart;
        dragged.style.gridRowStart = tempRow;
        dragged.style.gridColumnStart = tempCol;
        checkAndLock();
      });
    });

    function checkAndLock() {
      let tuttiGiusti = true;
      pezzi.forEach(p => {
        const correctRow = parseInt(p.dataset.row) + 1;
        const correctCol = parseInt(p.dataset.col) + 1;
        const currentRow = parseInt(p.style.gridRowStart);
        const currentCol = parseInt(p.style.gridColumnStart);
        if (correctRow === currentRow && correctCol === currentCol) {
          if (!p.classList.contains("locked")) {
            p.classList.add("locked");
            p.draggable = false;
          }
        } else tuttiGiusti = false;
      });

      if (tuttiGiusti && !completato) {
        completato = true;
        const totalTime = Math.floor((Date.now() - startTime) / 1000);
        popupText.textContent = `${utente}, hai completato il puzzle in ${totalTime} secondi! üéÑ`;
        popup.classList.add("active");
        salvaPunteggio(utente, totalTime);
      }
    }

    closePopup.addEventListener("click", () => {
      popup.classList.remove("active");
      leaderboard.classList.add("visible");
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    });

    function salvaPunteggio(nome, tempo) {
      const key = "punteggi_giorno1";
      let punteggi = JSON.parse(localStorage.getItem(key)) || [];
      punteggi.push({ nome, tempo });
      punteggi.sort((a, b) => a.tempo - b.tempo);
      punteggi = punteggi.slice(0, 10);
      localStorage.setItem(key, JSON.stringify(punteggi));
      mostraClassifica();
    }

    function mostraClassifica() {
      const key = "punteggi_giorno1";
      const punteggi = JSON.parse(localStorage.getItem(key)) || [];
      table.innerHTML = "<tr><th>Nome</th><th>Tempo (s)</th></tr>";
      punteggi.forEach(p => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${p.nome}</td><td>${p.tempo}</td>`;
        table.appendChild(row);
      });
    }

    mostraClassifica();
  </script>
</body>
</html>
